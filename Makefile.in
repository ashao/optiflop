CC=@CC@
CFLAGS=@CFLAGS@

LD=@CC@
LDFLAGS=-lm -lrt	# TODO: Integrate with autoconf

# Paths to platform-specific source
TSC_PATH=@tsc_path@
ARCH=x86
AVX512=generic/avx512

all: gcc

# Platforms

# NOTE: Using -mavx in place of -march=corei7-avx (or native) shows some minor
# changes in performance, on the order of 10 to 100 MFLOP/s.  In general, -mavx
# is slightly faster across the tests, although y[:] = x[:] + y[:] is slighly
# faster when -mavx is removed.
#
# The reason for this is still not clear.  Please experiment on your platform.

gcc: CC=gcc -std=gnu99 -g -I.
gcc: CFLAGS=-mavx -O3 -fno-builtin
gcc: LOOP=-funroll-loops --param max-unroll-times=2
gcc: flop

intel: CC=icc -std=gnu99 -g -I.
intel: CFLAGS=-xavx -O3 -fno-builtin
intel: flop

stream: CC=icc -std=gnu99 -I.
stream: CFLAGS=-xavx -O3 -mcmodel=medium -ffreestanding -qopt-streaming-stores always
stream: flop

knl: CC=icc -I.
knl: CFLAGS=-std=gnu99 -xMIC-AVX512 -O3 -DBYTEALIGN=64
knl: flop

fcc: CC=fccpx -Xg -I.
fcc: CFLAGS=-std=gnu99 -Kfast
fcc: flop

power: CC=gcc -std=gnu99 -g -I.
power: CFLAGS=-mpowerpc -O3 -fno-builtin
power: LOOP=-funroll-loops --param max-unroll-times=2
power: flop

gpu: CC=gcc -std=gnu99 -g -I.
gpu: CFLAGS=-mavx -O3 -fno-builtin
gpu: LOOP=-funroll-loops --param max-unroll-times=2
gpu: CXX=g++
gpu: gpuflop

# Build rules

gpuflop: main.o input.o bench.o stopwatch.o stopwatch_tsc.o \
	avx.o avx512.o roof.o dummy.o gpu_roof.o
	$(CXX) $(LDFLAGS) -lcudart -pthread -o $@ $^

flop: main.o input.o bench.o stopwatch.o stopwatch_tsc.o \
	avx.o avx512.o roof.o dummy.o gpu_roof_null.o
	$(CC) -pthread -o $@ $^ $(LDFLAGS)

main.o: main.c avx.h roof.h bench.h
	$(CC) -c -pthread -o $@ $<

input.o: input.c input.h
	$(CC) -c -pthread -o $@ $<

bench.o: bench.c bench.h
	$(CC) -c -pthread -o $@ $<

avx.o: $(ARCH)/avx.c avx.h bench.h stopwatch.h
	$(CC) $(CFLAGS) -c -o $@ $<

avx512.o: $(AVX512)/avx512.c avx512.h bench.h stopwatch.h
	$(CC) $(CFLAGS) -c -o $@ $<

roof.o: roof.c roof.h bench.h stopwatch.h
	$(CC) $(CFLAGS) $(LOOP) -c -o $@ $<

dummy.o: dummy.c
	$(CC) -c -o $@ $<

stopwatch.o: stopwatch.c stopwatch.h
	$(CC) -O2 -c -o $@ $<

stopwatch_tsc.o: $(TSC_PATH)/stopwatch_tsc.c
	$(CC) -O2 -c -o $@ $<

gpu_roof_null.o: generic/gpu_roof.c
	$(CC) -O2 -c -o $@ $<

gpu_roof.o: cuda/gpu_roof.cu
	nvcc -I. -c -o $@ $<

clean:
	$(RM) flop gpuflop *.o *.h.gch
